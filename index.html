<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Histograph IO</title>
  <meta name="description" content="Histograph IO - Drag'n'drop file uploads!">
  <meta name="author" content="Bert Spaan">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <script src="js/dropzone.min.js"></script>
  <script src="js/d3.v3.min.js"></script>

  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">

  <link rel="stylesheet" href="css/basic.min.css">
  <link rel="stylesheet" href="css/dropzone.min.css">

  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <div class="row">
      <h1>Histograph IO</h1>
      <p>
        Drag and drop <a href="http://ndjson.org/">NDJSON</a> files into
		Histograph! Files must be named <code>&lt;dataset&gt;.pits.ndjson</code>
		or <code>&lt;dataset&gt;.relations.ndjson</code>, and adhere to <a href="https://github.com/histograph/schemas/tree/master/json">Histograph's JSON schemas</a>. Also, the data dataset <code>&lt;dataset&gt;</code> must already exist in the API.
      </p>
      <p>
        <table id="config">
          <tr>
            <td>API URL:</td>
            <td>
              <input type="text" name="apiUrl" value="https://api.histograph.io/"/>
            </td>
          </tr>
          <tr>
            <td>Username:</td>
            <td>
              <input type="text" name="username" />
            </td>
          </tr>
          <tr>
            <td>Password:</td>
            <td>
              <input type="password" name="password" />
            </td>
          </tr>
        </table>
      </p>
      <form action="/datasets" class="dropzone" id="histograph"></form>
      <h2>Datasets</h2>
      <p id="datasets"></p>
    </div>
  </div>
  <script>
    var config = {
      apiUrl: 'https://api.histograph.io/',
      username: '',
      password: ''
    };

    function refreshDatasets() {
      d3.select('#datasets').selectAll('span').remove();

      d3.json(config.apiUrl + 'datasets', function(json) {
        d3.select('#datasets').selectAll('span')
            .data(json).enter()
          .append('span')
            .each(function(d, i) {
              d3.select(this).append('code').append('a')
                  .attr('href', config.apiUrl + 'datasets/' + d.id)
                  .html(d.title)
              if (i < json.length - 1) {
                d3.select(this).html(d3.select(this).html() + ', ');
              }
            });
      });
    }

    d3.selectAll('#config input').on('change', function() {
      var name = d3.select(this).attr('name');
      config[name] = this.value;

      if (name === 'apiUrl') {
        refreshDatasets();
      }
    });

    function urlFromFilename(filename) {
      var fileElements = filename.split('.');
      if (fileElements.length == 3) {
        return config.apiUrl + 'datasets/' + fileElements[0] + '/' + fileElements[1];
      } else {
        return null;
      }
    }

    function makeBasicAuth(username, password) {
      var hash = btoa(username + ':' + password);
      return 'Basic ' + hash;
    }

    Dropzone.options.histograph = {
      clickable: false,
      maxFilesize: 1024, // MB
      acceptedFiles: '.ndjson',
      method: 'put',
      headers: {
        Authorization: makeBasicAuth(config.username, config.password)
      },
      init: function() {
        this.on('processing', function(file) {
          this.options.url = urlFromFilename(file.name);
        });
      },
      accept: function(file, done) {
        // file.name must use naming convention: "dataset.type.extension";
        var url = urlFromFilename(file.name);
        if (url) {
          done();
        } else {
          done('Please use correct naming convention for file!');
        }
      }
    };

    refreshDatasets();
  </script>
</body>
</html>
